name: Dynamic Release Automation ğŸš€

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-release:
    runs-on: windows-latest

    permissions:
      contents: write # å¿…é¡»æƒé™ï¼šå…è®¸ä¸Šä¼  Release é™„ä»¶å’Œæ¨é€ä»£ç 

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…³é”®ä¿®æ”¹ï¼šè·å–å®Œæ•´å†å²ï¼Œç¡®ä¿èƒ½åˆ‡æ¢åˆ° main åˆ†æ”¯è¿›è¡Œå›å†™

      # ----------------------------------------------------
      # 1. è·å–åŒ…ç®¡ç†å™¨é…ç½®
      # ----------------------------------------------------
      - name: ğŸ” Get Package Manager
        id: get_config
        shell: bash
        run: |
          PACKAGE_MANAGER=$(jq -r '.ciConfig.packageManager' package.json)
          echo "PACKAGE_MANAGER=$PACKAGE_MANAGER" >> $GITHUB_ENV

      # ----------------------------------------------------
      # 2. å‡†å¤‡ Node ç¯å¢ƒ
      # ----------------------------------------------------
      - name: ğŸ› ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: âš™ï¸ Enable Corepack
        if: ${{ env.PACKAGE_MANAGER == 'pnpm' }}
        shell: bash
        run: corepack enable pnpm

      - name: ğŸ“¥ Cache dependencies
        uses: actions/cache@v4
        if: ${{ env.PACKAGE_MANAGER == 'pnpm' }}
        with:
          path: ~\AppData\Local\pnpm\store\v3
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # ----------------------------------------------------
      # 3. å®‰è£…ä¾èµ–
      # ----------------------------------------------------
      - name: ğŸ“¦ Install Dependencies
        shell: powershell
        run: |
          if ("${{ env.PACKAGE_MANAGER }}" -eq "pnpm") {
            pnpm install --frozen-lockfile --store-dir "$env:AppData\Local\pnpm\store\v3"
          } elseif ("${{ env.PACKAGE_MANAGER }}" -eq "npm") {
            npm install
          }

      # ----------------------------------------------------
      # [æ–°å¢] ä¸´æ—¶åŒæ­¥ Tag ç‰ˆæœ¬å·ç”¨äºæ„å»º
      # ----------------------------------------------------
      - name: ğŸ”„ Temp Sync Version for Build
        shell: powershell
        run: |
          $tagName = "${{ github.ref_name }}"
          $version = $tagName -replace "^v", ""
          Write-Host "Temp bumping package.json to: $version for release build"
          npm version $version --no-git-tag-version --allow-same-version

      # ----------------------------------------------------
      # 4. æ„å»ºå¹¶ç›´æ¥å‘å¸ƒ
      # ----------------------------------------------------
      - name: ğŸš€ Build and Publish
        shell: powershell
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç­–ç•¥è¯´æ˜ï¼š
          # ä¸ä¼ é€’é¢å¤–å‚æ•°ï¼Œç›´æ¥è¿è¡Œ electron:build è„šæœ¬ã€‚
          # è¿™æ ·å¯ä»¥é¿å…å‚æ•°è¯¯ä¼ ç»™è„šæœ¬æœ«å°¾çš„ 'node -e' å¯¼è‡´æŠ¥é”™ã€‚
          # electron-builder ä¼šè‡ªåŠ¨è¯»å– package.json ä¸­çš„ releaseType: release é…ç½®ã€‚

          if ("${{ env.PACKAGE_MANAGER }}" -eq "pnpm") {
            pnpm run electron:build
          } elseif ("${{ env.PACKAGE_MANAGER }}" -eq "npm") {
            npm run electron:build
          } else {
            Write-Error "Unknown package manager"
            exit 1
          }

      # ----------------------------------------------------
      # [æ–°å¢] è‡ªåŠ¨å°†ç‰ˆæœ¬å·å†™å›ä¸»åˆ†æ”¯ (Sync Back)
      # ----------------------------------------------------
      - name: ğŸ’¾ Sync Version Back to Repo
        if: success() # åªæœ‰æ„å»ºå‘å¸ƒæˆåŠŸäº†æ‰æ‰§è¡Œè¿™ä¸€æ­¥
        shell: bash   # ä½¿ç”¨ bash æ–¹ä¾¿å¤„ç† git å‘½ä»¤
        run: |
          # é…ç½®æœºå™¨äººèº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # è·å–çº¯æ•°å­—ç‰ˆæœ¬å· (å»æ‰ v)
          TAG_NAME="${{ github.ref_name }}"
          VERSION=${TAG_NAME#v}
          echo "Target Version to write back: $VERSION"

          # åˆ‡æ¢å›ä¸»åˆ†æ”¯ (Tag æ˜¯åˆ†ç¦»å¤´æŒ‡é’ˆï¼Œå¿…é¡»åˆ‡å›ä¸»åˆ†æ”¯æ‰èƒ½æäº¤)
          # âš ï¸ æ³¨æ„ï¼šå¦‚æœä½ ä»£ç åº“çš„ä¸»åˆ†æ”¯å« masterï¼Œè¯·æŠŠä¸‹é¢çš„ main éƒ½æ”¹ä¸º master
          git fetch origin main
          git checkout main
          git pull origin main

          # å†æ¬¡ä¿®æ”¹ package.json (å› ä¸ºåˆ‡æ¢åˆ†æ”¯åæ–‡ä»¶è¢«è¿˜åŸäº†)
          npm version $VERSION --no-git-tag-version --allow-same-version

          # æäº¤å¹¶æ¨é€
          if [[ -n $(git status --porcelain) ]]; then
            echo "Version changed. Committing..."
            git add package.json
            
            # [skip ci] å¾ˆé‡è¦ï¼Œé˜²æ­¢è¿™æ¬¡æäº¤åˆè§¦å‘æ–°çš„æ„å»ºå¾ªç¯
            git commit -m "chore: auto bump version to $VERSION [skip ci]"
            
            git push origin main
            echo "âœ… Successfully synced version back to main branch!"
          else
            echo "Version is already up to date."
          fi